#!/usr/bin/env bash

source .env.staging

runner_token=$(gh api /repos/${GH_USERNAME}/${GH_REPO}/actions/runners -q '.runners[0].id')

if [ -n "$runner_token" ]; then
  gh api /repos/${GH_USERNAME}/${GH_REPO}/actions/runners/$runner_token --method DELETE --silent
fi

export GH_RUNNER_TOKEN=$(gh api -q '.token' -X POST /repos/${GH_USERNAME}/${GH_REPO}/actions/runners/registration-token)

rm -rf .cloud/processed/docker_install.sh
envsubst < .cloud/templates/docker_install_template.sh > .cloud/processed/docker_install.sh
export DOCKER_INSTALL_CONTENT=$(base64 -b 0 -i .cloud/processed/docker_install.sh)

rm -rf .cloud/processed/github_runner_install.sh
envsubst < .cloud/templates/github_runner_install_template.sh > .cloud/processed/github_runner_install.sh
export GITHUB_RUNNER_INSTALL_CONTENT=$(base64 -b 0 -i .cloud/processed/github_runner_install.sh)

rm -rf .cloud/processed/zsh_install.sh
envsubst < .cloud/templates/zsh_install_template.sh > .cloud/processed/zsh_install.sh
export ZSH_INSTALL_CONTENT=$(base64 -b 0 -i .cloud/processed/zsh_install.sh)

rm -rf .cloud/processed/prezto_install.sh
envsubst < .cloud/templates/prezto_install_template.sh > .cloud/processed/prezto_install.sh
export PREZTO_INSTALL_CONTENT=$(base64 -b 0 -i .cloud/processed/prezto_install.sh)

rm -rf cloud-init.yml
envsubst < .cloud/templates/cloud-init_template.yml > cloud-init.yml
